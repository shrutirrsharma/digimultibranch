trigger:
  - '*'   # pipeline should be triggered on any changes to the repository (any branch)

pr:
  - '*'   # pipeline should also run on any pull requests

jobs:

- job: Build
  pool:
    name: Default

  variables:
    solution: '**/*.sln'
    buildPlatform: 'Any CPU'
    buildConfiguration: 'Release'

  steps:
  - task: NuGetToolInstaller@1

  - task: NuGetCommand@2
    inputs:
      restoreSolution: '$(solution)'

  - task: VSBuild@1
    inputs:
      solution: '$(solution)'
      msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactStagingDirectory)"'
      platform: '$(buildPlatform)'
      configuration: '$(buildConfiguration)'

  - task: VSTest@2
    inputs:
      platform: '$(buildPlatform)'
      configuration: '$(buildConfiguration)'

  - task: CopyFiles@2
    displayName: 'Copy Main Branch'
    condition: eq(variables['Build.SourceBranchName'], 'main')     
    inputs:
      SourceFolder: '$(Build.ArtifactStagingDirectory)'
      Contents: '**'
      TargetFolder: 'C:\Users\IIS-Windows-name\Downloads\vsts-agent-win-x64-3.244.1\_work\ArtifactFolderMain'
      CleanTargetFolder: true

  # Add this section back in as commented
  # - task: CopyFiles@2
  #   displayName: 'Copy Prod Branch'
  #   condition: eq(variables['Build.SourceBranchName'], 'production')     
  #   inputs:
  #     SourceFolder: '$(Build.ArtifactStagingDirectory)'
  #     Contents: '**'
  #     TargetFolder: 'C:/AfiyaAgentAzure/New folder/_work/14/ArtifactFolderProd'
  #     CleanTargetFolder: true

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: '$(Pipeline.Workspace)'
      artifact: 'Drop'
      publishLocation: 'pipeline'

- job: DeployUAT
  displayName: 'Deploy to UAT'
  dependsOn: Build
  condition: eq(variables['Build.SourceBranchName'], 'main')
  pool:
    name: Default
  steps:
  - task: AzureRmWebAppDeployment@4
    displayName: 'Deploy to UAT web app'
    inputs:
      ConnectionType: 'AzureRM'
      azureSubscription: 'IIS-Service-Connection'  # Correct service connection name
      appType: 'webApp'
      WebAppName: 'MyWebsite'
      deployToSlotOrASE: false
      ResourceGroupName: 'IIS-Deployment'
      SlotName: 'production'
      packageForLinux: 'C:\Users\IIS-Windows-name\Downloads\vsts-agent-win-x64-3.244.1\_work\ArtifactFolderMain\**\*.zip'

# - job: DeployProd
#   displayName: 'Deploy to Production'
#   dependsOn: Build
#   condition: eq(variables['Build.SourceBranchName'], 'production')
#   pool:
#     name: Default
#   steps:
#   - task: AzureRmWebAppDeployment@4
#     displayName: 'Deploy to Production web app'
#     inputs:
#       ConnectionType: 'AzureRM'
#       azureSubscription: 'IIS-Service-Connection'  # Correct service connection name
#       appType: 'webApp'
#       WebAppName: 'IIS-Windows-Deployment'
#       deployToSlotOrASE: true
#       ResourceGroupName: 'IIS-Deployment'
#       SlotName: 'production'
#       packageForLinux: 'C:/AfiyaAgentAzure/New folder/_work/14/ArtifactFolderProd/**/*.zip'
